- name: "Check if SqlServer Module is Installed on Target"
        shell: bash
        run: |
          echo "Checking if SqlServer module is installed on target EC2 instance..."
          command_id=$(aws ssm send-command \
            --region us-west-2 \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunPowerShellScript" \
            --parameters commands="[
              \"if (Get-Module -ListAvailable -Name SqlServer) {\",
              \"    Write-Host 'SqlServer module is installed.'\",
              \"} else {\",
              \"    Write-Host 'SqlServer module is NOT installed on this instance!'\",
              \"}\"
            ]" \
            --timeout-seconds 300 \
            --max-concurrency "50" \
            --max-errors "0" \
            --query "Command.CommandId" \
            --output text)

          echo "CHECK_SQLSERVER_COMMAND_ID=$command_id" >> $GITHUB_ENV
          aws ssm wait command-executed --region us-west-2 --command-id "$command_id" --instance-id "$INSTANCE_ID"

      - name: "Retrieve Check Module Output"
        shell: bash
        run: |
          echo "Retrieving check result..."
          aws ssm get-command-invocation \
            --region us-west-2 \
            --command-id "${{ env.CHECK_SQLSERVER_COMMAND_ID }}" \
            --instance-id "$INSTANCE_ID" \
            --query 'StandardOutputContent' --output text
