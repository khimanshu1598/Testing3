- name: Send script to EC2 and save in C:\Temp\EmployeeInvitation
  shell: pwsh
  run: |
    $encoded = "${{ steps.encode.outputs.encoded }}"

    # Escape the inline PowerShell for SSM CLI
    $ssmCommand = "powershell -Command `"\$base64='${encoded}';\$decoded=[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String(\$base64));if (!(Test-Path -Path 'C:\\Temp\\EmployeeInvitation')) { New-Item -ItemType Directory -Path 'C:\\Temp\\EmployeeInvitation' | Out-Null } else { Get-ChildItem -Path 'C:\\Temp\\EmployeeInvitation' -Recurse -Force | Remove-Item -Force -Recurse }; Set-Content -Path 'C:\\Temp\\EmployeeInvitation\\sql-actions.ps1' -Value \$decoded -Force`""

    $commandId = aws ssm send-command `
      --document-name "AWS-RunPowerShellScript" `
      --instance-ids "${{ inputs.instance_id }}" `
      --region "${{ inputs.region }}" `
      --parameters "commands=[$ssmCommand]" `
      --comment "Create/Clean EmployeeInvitation dir and send script" `
      --query "Command.CommandId" `
      --output text

    echo "Command ID: $commandId"
