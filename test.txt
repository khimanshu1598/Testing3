- name: Send PowerShell script to EC2 via SSM
          id: run-ssm-script
          shell: powershell
          run: |
            $parameter_store_name = "${{ env.SQL_PASSWORD_PARAMETER_STORE }}"
            $region = "${{ env.AWS_REGION }}"
            # Fetch the password from SSM (with decryption)
            $sqlPassword = aws ssm get-parameter `
              --name "$parameter_store_name" `
              --with-decryption `
              --region "$region" `
              --query "Parameter.Value" `
              --output text
            $scriptPath = "od-gha-files/sql-actions.ps1"
            $encodedScript = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes((Get-Content $scriptPath -Raw)))
        
            # Optional: Inject variable values if needed (or handle in the script itself)
            $paramBlock = @"
            `$serverInstance = ${{ env.INSTANCE_ID }}
            `$databaseName = ${{ env.DB_NAME }}
            `$sqlUserName = ${{ env.SQL_USER_NAME }}
            `$sqlPassword = "$sqlPassword"
            `$adUserSsmPassword = '/secure/dbpassword'
            `$sqlActivity = 'create-user'
            "@
            
            # Combine parameter block + script and encode
            $scriptCombined = "$paramBlock`n$(Get-Content $scriptPath -Raw)"
            $encodedFinal = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($scriptCombined))
            
            # Create final command to decode and run on EC2
            $finalCommand = "powershell -NoProfile -EncodedCommand $encodedFinal"
            
        
            # Send the command
            $commandId = aws ssm send-command `
            --document-name "AWS-RunPowerShellScript" `
            --targets "Key=instanceIds,Values=$env:INSTANCE_ID" `
            --parameters commands=["$finalCommand"] `
            --comment "Run create-user script via SSM" `
            --region "$env:AWS_REGION" `
            --query "Command.CommandId" `
            --output text

            echo "command-id=$commandId" >> $env:GITHUB_OUTPUT
