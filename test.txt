name: 'Generate and Store Password'
description: 'Generates a secure 12-character password (2 of each type) and stores it in AWS SSM'

inputs:
  parameter-name:
    description: 'SSM Parameter Store path (e.g., /prod/db/password)'
    required: true
  aws-region:
    description: 'AWS region (default: us-east-1)'
    default: 'us-east-1'

outputs:
  parameter-path:
    description: 'The SSM path where password was stored'

runs:
  using: "composite"
  steps:
    - name: Generate password
      shell: pwsh
      run: |
        # Generate 2 of each character type (total 12 chars)
        $upper = (65..90 | Get-Random -Count 2 | % { [char]$_ })
        $lower = (97..122 | Get-Random -Count 2 | % { [char]$_ })
        $numbers = (48..57 | Get-Random -Count 2 | % { [char]$_ })
        $special = (33..47 | Get-Random -Count 2 | % { [char]$_ })
        
        # Combine and shuffle
        $password = -join ($upper + $lower + $numbers + $special | Sort-Object { Get-Random })
        
        echo "::add-mask::$password"
        echo "generated-password=$password" >> $GITHUB_OUTPUT

    - name: Store in Parameter Store
      shell: pwsh
      run: |
        aws ssm put-parameter \
          --name "${{ inputs.parameter-name }}" \
          --value "${{ steps.generate-password.outputs.generated-password }}" \
          --type "SecureString" \
          --overwrite \
          --region "${{ inputs.aws-region }}"
        echo "parameter-path=${{ inputs.parameter-name }}" >> $GITHUB_OUTPUT
