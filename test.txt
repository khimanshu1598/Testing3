name: Test Transfer Script Action

on:
  pull_request:
    paths:
      - 'paassql-pipelines/transfer-script/**'
      - '.github/workflows/test-transfer-script.yaml'

env:
  TEST_AWS_REGION: "us-west-2"
  DESTINATION_PATH: "C:\\Temp\\Superannuation"
  MATRIX_INSTANCE_LIST: ${{ vars.MATRIX_INSTANCE_LIST }}

jobs:
  validate-variables:
    runs-on: ubuntu-latest
    outputs:
      vars_valid: ${{ steps.validate.outputs.valid }}
    steps:
    - name: Validate required variables
      id: validate
      run: |
        if [ -z "${{ vars.OIDC_ROLE_ARN }}" ] || [ -z "${{ vars.DEPLOYMENT_ROLE_ARN }}" ] || [ -z "${{ vars.MATRIX_INSTANCE_LIST }}" ]; then
          echo "::error::Missing required variables. Ensure OIDC_ROLE_ARN, DEPLOYMENT_ROLE_ARN, and MATRIX_INSTANCE_LIST are set"
          echo "valid=false" >> $GITHUB_OUTPUT
        else
          echo "valid=true" >> $GITHUB_OUTPUT
        fi

  success-test:
    runs-on: [self-hosted, windows, runners-us-west-2]
    environment: test
    needs: validate-variables
    if: needs.validate-variables.outputs.vars_valid == 'true'
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Create test script
      shell: powershell
      run: |
        New-Item -ItemType File -Path "./paassql-pipelines/transfer-script/sql-actions.ps1" -Force
        Add-Content -Path "./paassql-pipelines/transfer-script/sql-actions.ps1" -Value "# Test script"

    - name: Run transfer action
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ${{ env.TEST_AWS_REGION }}

  input-validation:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: [validate-variables, success-test]
    if: needs.validate-variables.outputs.vars_valid == 'true'
    strategy:
      matrix:
        missing_input: ['destination-path', 'aws-region']
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Run with missing input
      id: action-run
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ matrix.missing_input != 'destination-path' && env.DESTINATION_PATH || '' }}
        aws-region: ${{ matrix.missing_input != 'aws-region' && env.TEST_AWS_REGION || '' }}
      continue-on-error: true

    - name: Verify failure
      if: steps.action-run.outcome != 'failure'
      run: echo "::error::Action should have failed with missing ${{ matrix.missing_input }}" && exit 1
