- name: Run remote PowerShell via SSM using script file
  id: run-script-ssm
  shell: pwsh
  run: |
    # Set variables
    $scriptPath = "od-gha-files/create-sql-user.ps1"
    $encodedScript = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes((Get-Content $scriptPath -Raw)))

    # Parameters to inject
    $paramBlock = @"
`$serverInstance = '$env:DB_SERVER_NAME'
`$databaseName = '$env:DB_NAME'
`$sqlUserName = '$env:SQL_USER_NAME'
`$sqlPassword = 'REPLACEME_SQL_PASSWORD'
`$adUserSsmPassword = '$env:SQL_PASSWORD_PARAMETER_STORE'
`$sqlActivity = 'validate-delete-user'
"@

    # Combine parameter block + script and encode
    $scriptCombined = "$paramBlock`n$(Get-Content $scriptPath -Raw)"
    $encodedFinal = [Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes($scriptCombined))

    # Create final command to decode and run on EC2
    $finalCommand = "powershell -NoProfile -EncodedCommand $encodedFinal"

    # Send the command
    $commandId = aws ssm send-command `
      --document-name "AWS-RunPowerShellScript" `
      --targets "Key=instanceIds,Values=$env:INSTANCE_ID" `
      --parameters commands=["$finalCommand"] `
      --comment "Run create-user script via SSM" `
      --region "$env:AWS_REGION" `
      --query "Command.CommandId" `
      --output text

    echo "command-id=$commandId" >> $env:GITHUB_OUTPUT
