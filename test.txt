name: Test Transfer Script Action

on:
  pull_request:
    paths:
      - 'paassql-pipelines/transfer-script/**'
      - '.github/workflows/test-transfer-script.yaml'

env:
  TEST_AWS_REGION: "us-west-2"
  DESTINATION_PATH: "C:\\Temp\\Superannuation"
  MATRIX_INSTANCE_LIST: ${{ vars.MATRIX_INSTANCE_LIST }}
  OIDC_ROLE_ARN: ${{ vars.OIDC_ROLE_ARN }}
  DEPLOYMENT_ROLE_ARN: ${{ vars.DEPLOYMENT_ROLE_ARN }}

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

jobs:
  success-test:
    runs-on: [self-hosted, windows, runners-us-west-2]
    environment: test
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      id: assume_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ env.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ env.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Create test script
      shell: powershell
      run: |
        New-Item -ItemType File -Path "./paassql-pipelines/transfer-script/sql-actions.ps1" -Force
        Add-Content -Path "./paassql-pipelines/transfer-script/sql-actions.ps1" -Value "# Test script"

    - name: Run transfer action
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ${{ env.TEST_AWS_REGION }}

  validate-destination-path:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: success-test
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      id: assume_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Test missing destination-path
      id: action_run
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ""
        aws-region: ${{ env.TEST_AWS_REGION }}
      continue-on-error: true

    - name: Verify failure
      if: ${{ !cancelled() && steps.action_run.outcome != 'failure' }}
      shell: powershell
      run: |
        Write-Error "Action should have failed with missing destination-path"
        exit 1

  validate-aws-region:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: validate-destination-path
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      id: assume_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ env.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ env.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Test missing aws-region
      id: action_run
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ""
      continue-on-error: true

    - name: Verify failure
      if: ${{ !cancelled() && steps.action_run.outcome != 'failure' }}
      shell: powershell
      run: |
        Write-Error "Action should have failed with missing aws-region"
        exit 1

  script-validation:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: [validate-destination-path, validate-aws-region]
    steps:
    - name: Checkout action
      uses: actions/checkout@v4

    - name: Assume OIDC role
      id: assume_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ env.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ env.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Delete script file
      shell: powershell
      run: |
        Remove-Item "./paassql-pipelines/transfer-script/sql-actions.ps1" -Force -ErrorAction SilentlyContinue

    - name: Verify script validation fails
      id: script_test
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ${{ env.TEST_AWS_REGION }}
      continue-on-error: true

    - name: Check failure
      if: ${{ !cancelled() && steps.script_test.outcome != 'failure' }}
      shell: powershell
      run: |
        Write-Error "Action should have failed with missing script file"
        exit 1
