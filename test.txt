name: 'Generate and Store Password'
description: 'Generates a secure 12-character password (2 of each type) and stores it in AWS SSM'

inputs:
  parameter-name:
    description: 'SSM Parameter Store path (e.g., /prod/db/password)'
    required: true
  aws-region:
    description: 'AWS region (default: us-east-1)'
    default: 'us-east-1'

outputs:
  parameter-path:
    description: 'The SSM path where password was stored'

runs:
  using: "composite"
  steps:
    - name: Generate password
      shell: pwsh
      run: |
        # Generate 2 of each character type (total 12 chars)
        $upper = (65..90 | Get-Random -Count 2 | % { [char]$_ })
        $lower = (97..122 | Get-Random -Count 2 | % { [char]$_ })
        $numbers = (48..57 | Get-Random -Count 2 | % { [char]$_ })
        $special = (33..47 | Get-Random -Count 2 | % { [char]$_ })
        
        # Combine and shuffle
        $password = -join ($upper + $lower + $numbers + $special | Sort-Object { Get-Random })
        
        echo "::add-mask::$password"
        echo "generated-password=$password" >> $GITHUB_OUTPUT

    - name: Store in Parameter Store
      shell: pwsh
      run: |
        aws ssm put-parameter \
          --name "${{ inputs.parameter-name }}" \
          --value "${{ steps.generate-password.outputs.generated-password }}" \
          --type "SecureString" \
          --overwrite \
          --region "${{ inputs.aws-region }}"
        echo "parameter-path=${{ inputs.parameter-name }}" >> $GITHUB_OUTPUT


=========

Refreshing environment variables from the registry for powershell.exe. Please wait...
Finished
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:3 char:5
+   --name "***" \
+     ~
Missing expression after unary operator '--'.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:3 char:5
+   --name "***" \
+     ~~~~
Unexpected token 'name' in expression or statement.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:4 char:5
+   --value "" \
+     ~
Missing expression after unary operator '--'.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:4 char:5
+   --value "" \
+     ~~~~~
Unexpected token 'value' in expression or statement.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:5 char:5
+   --type "SecureString" \
+     ~
Missing expression after unary operator '--'.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:5 char:5
+   --type "SecureString" \
+     ~~~~
Unexpected token 'type' in expression or statement.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:6 char:5
+   --overwrite \
+     ~
Missing expression after unary operator '--'.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:6 char:5
+   --overwrite \
+     ~~~~~~~~~
Unexpected token 'overwrite' in expression or statement.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:7 char:5
+   --region "us-west-2"
+     ~
Missing expression after unary operator '--'.
At C:\actions-runner\_work\_temp\9f4672b0-0b05-465b-a3c5-94dbe89597da.ps1:7 char:5
+   --region "us-west-2"
+     ~~~~~~
Unexpected token 'region' in expression or statement.
    + CategoryInfo          : ParserError: (:) [], ParseException
    + FullyQualifiedErrorId : MissingExpressionAfterOperator
 
Error: Process completed with exit code 1.
