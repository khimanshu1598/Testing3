name: Test OIDC and SqlPackage Installation

on:
  pull_request:
    paths:
      - 'paassql-pipelines/oidc-and-sqlpackage-installation/**'
      - '.github/workflows/test-oidc-and-sqlpackage-installation.yml'

permissions:
  contents: read

jobs:
  success-test:
    name: Success test (Windows only)
    environment: test
    runs-on: [self-hosted, windows, x64, runners-us-east-1]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run oidc-and-sqlpackage-installation
        uses: ./paassql-pipelines/oidc-and-sqlpackage-installation

      - name: ✅ Verify SqlPackage was extracted
        shell: pwsh
        run: |
          if (-not $env:SQLPACKAGE_PATH) {
            Write-Error "❌ SQLPACKAGE_PATH was not set in the environment."
            exit 1
          }

          if (-not (Test-Path -Path $env:SQLPACKAGE_PATH)) {
            Write-Error "❌ SqlPackage path '$env:SQLPACKAGE_PATH' does not exist."
            exit 1
          }

          $exePath = Join-Path $env:SQLPACKAGE_PATH 'sqlpackage.exe'
          if (-not (Test-Path -Path $exePath)) {
            Write-Error "❌ sqlpackage.exe not found in extracted directory."
            exit 1
          }

          Write-Host "✅ SqlPackage installation verified at: $exePath"
          & $exePath /? | Out-Host  # Optional: Print sqlpackage help to confirm it's working
