# Define SQLPackage Path
$SqlPackageFilePath = "C:\Program Files (x86)\Microsoft SQL Server\130\DAC\bin\SqlPackage.exe"

# Define Variables
$Action = "Extract"
$TargetServers = "employeeinvitation.db.livestage6.test.abc.com"
$DatabaseNames = "EmployeeInvitation"
$SQL_USER = "your_sql_user"
$SQL_PASSWORD = "your_sql_password"

# Convert SQL password to secure string
$SecurePassword = ConvertTo-SecureString -String $SQL_PASSWORD -AsPlainText -Force
$Credential = New-Object System.Management.Automation.PSCredential ($SQL_USER, $SecurePassword)

# Define script to execute under specific credentials
$scriptToRun = "C:\Temp\dacpac-execution.ps1"

# Split out target servers
$targetServerCollection = $TargetServers -split ","
$databaseNameCollection = $DatabaseNames -split ","

# Create script dynamically
@"
`$SqlPackageFilePath = '$SqlPackageFilePath'
`$targetServerCollection = '$TargetServers' -split ","
`$databaseNameCollection = '$DatabaseNames' -split ","

foreach (`$targetServer in `$targetServerCollection) {
    foreach (`$databaseName in `$databaseNameCollection) {
        `$connectionString = "Server=`$targetServer;Database=`$databaseName;Integrated Security=True;"
        `$sqlPackageCommand = "/Action:$Action /TargetFile:C:/test.dacpac /SourceConnectionString=`"`$connectionString`""
        `$fullCommand = "& `"`$SqlPackageFilePath`" `$sqlPackageCommand"
        Invoke-Expression `$fullCommand
    }
}
"@ | Out-File -FilePath $scriptToRun -Encoding utf8

# Execute script as different user
Start-Process powershell.exe -Credential $Credential -ArgumentList "-File $scriptToRun" -NoNewWindow -Wait
