name: Test Transfer Script Action

on:
  pull_request:
    paths:
      - 'paassql-pipelines/transfer-script/**'
      - '.github/workflows/test-transfer-script.yaml'

permissions:
  id-token: write
  contents: read
  pull-requests: write
  actions: read

env:
  TEST_AWS_REGION: "us-west-2"
  DESTINATION_PATH: "C:\\Temp\\Superannuation"
  MATRIX_INSTANCE_LIST: ${{ vars.MATRIX_INSTANCE_LIST }}  # Defined at workflow level

jobs:
  success-test:
    runs-on: [self-hosted, windows, runners-us-west-2]
    environment: test
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Assume OIDC role
      id: assume_oidc_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Create test script
      shell: powershell
      run: |
        $scriptPath = "${{ github.workspace }}/paassql-pipelines/transfer-script/sql-actions.ps1"
        New-Item -ItemType File -Path $scriptPath -Force | Out-Null
        Add-Content -Path $scriptPath -Value "# Test script content"
        Write-Host "Created test script at $scriptPath"

    - name: Run transfer action
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ${{ env.TEST_AWS_REGION }}

  input-validation:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: success-test
    strategy:
      matrix:
        missing_input: ['destination-path', 'aws-region']
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Assume OIDC role
      id: assume_oidc_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Test missing [${{ matrix.missing_input }}]
      id: validation-test
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ matrix.missing_input != 'destination-path' && env.DESTINATION_PATH || '' }}
        aws-region: ${{ matrix.missing_input != 'aws-region' && env.TEST_AWS_REGION || '' }}
      continue-on-error: true

    - name: Verify failure
      if: ${{ !cancelled() && steps.validation-test.outcome != 'failure' }}
      shell: powershell
      run: exit 1

  script-validation:
    runs-on: [self-hosted, windows, runners-us-west-2]
    needs: input-validation
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Assume OIDC role
      id: assume_oidc_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ vars.OIDC_ROLE_ARN }}
        target-role-to-assume: ${{ vars.DEPLOYMENT_ROLE_ARN }}
        aws-region: ${{ env.TEST_AWS_REGION }}

    - name: Delete script file
      shell: powershell
      run: |
        Remove-Item "${{ github.workspace }}/paassql-pipelines/transfer-script/sql-actions.ps1" -Force -ErrorAction SilentlyContinue

    - name: Verify script validation fails
      id: script-test
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: ${{ env.MATRIX_INSTANCE_LIST }}
      with:
        destination-path: ${{ env.DESTINATION_PATH }}
        aws-region: ${{ env.TEST_AWS_REGION }}
      continue-on-error: true

    - name: Check failure
      if: ${{ !cancelled() && steps.script-test.outcome != 'failure' }}
      shell: powershell
      run: exit 1
