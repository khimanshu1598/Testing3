name: Test Validate Create SQL User

on:
  pull_request:
    paths:
      - 'paassql-pipelines/validate-create-sql-user/**'
      - '.github/workflows/test-validate-create-sql-user.yml'

permissions:
  contents: read

jobs:
  success-test-windows:
    environment: test
    runs-on: [self-hosted, windows, runners-us-east-1]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call validate-create-sql-user action with valid inputs
        uses: ./paassql-pipelines/validate-create-sql-user
        with:
          destination-path: 'C:\temp\sql-scripts'
          aws-region: 'us-east-1'
          sql-password-parameter-store: '/test/sql/password'
          db-name: 'TestDatabase'
          sql-user-name: 'TestUser'
          username: 'DOMAIN\testuser'
          needs-windows-authentication: true

  failure-test-missing-required-inputs:
    environment: test
    runs-on: [self-hosted, windows, runners-us-east-1]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call action with missing destination-path
        id: missing-destination-path
        uses: ./paassql-pipelines/validate-create-sql-user
        with:
          aws-region: 'us-east-1'
          sql-password-parameter-store: '/test/sql/password'
          db-name: 'TestDatabase'
          sql-user-name: 'TestUser'
          username: 'DOMAIN\testuser'
        continue-on-error: true

      - name: Check missing destination-path step failed
        if: ${{ !cancelled() }}
        run: |
          if ("${{ steps.missing-destination-path.outcome }}" -ne "failure") {
            Write-Host "Action with missing destination-path should have failed"
            exit 1
          }

      - name: Call action with missing aws-region
        id: missing-aws-region
        uses: ./paassql-pipelines/validate-create-sql-user
        with:
          destination-path: 'C:\temp\sql-scripts'
          sql-password-parameter-store: '/test/sql/password'
          db-name: 'TestDatabase'
          sql-user-name: 'TestUser'
          username: 'DOMAIN\testuser'
        continue-on-error: true

      - name: Check missing aws-region step failed
        if: ${{ !cancelled() }}
        run: |
          if ("${{ steps.missing-aws-region.outcome }}" -ne "failure") {
            Write-Host "Action with missing aws-region should have failed"
            exit 1
          }

      - name: Call action with missing sql-password-parameter-store
        id: missing-sql-password
        uses: ./paassql-pipelines/validate-create-sql-user
        with:
          destination-path: 'C:\temp\sql-scripts'
          aws-region: 'us-east-1'
          db-name: 'TestDatabase'
          sql-user-name: 'TestUser'
          username: 'DOMAIN\testuser'
        continue-on-error: true

      - name: Check missing sql-password-parameter-store step failed
        if: ${{ !cancelled() }}
        run: |
          if ("${{ steps.missing-sql-password.outcome }}" -ne "failure") {
            Write-Host "Action with missing sql-password-parameter-store should have failed"
            exit 1
          }

  failure-test-sql-authentication:
    environment: test
    runs-on: [self-hosted, windows, runners-us-east-1]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Call action with SQL Server Authentication
        uses: ./paassql-pipelines/validate-create-sql-user
        with:
          destination-path: 'C:\temp\sql-scripts'
          aws-region: 'us-east-1'
          sql-password-parameter-store: '/test/sql/password'
          db-name: 'TestDatabase'
          sql-user-name: 'TestUser'
          username: 'DOMAIN\testuser'
          needs-windows-authentication: false
