- name: Send PowerShell script to EC2 via SSM
  id: run-ssm-script
  shell: pwsh
  run: |
    $scriptContent = Get-Content "od-gha-files/create-sql-user.ps1" -Raw

    # Optional: Inject variable values if needed (or handle in the script itself)
    $paramBlock = @"
`$serverInstance = '$env:DB_SERVER_NAME'
`$databaseName = '$env:DB_NAME'
`$sqlUserName = '$env:SQL_USER_NAME'
`$sqlPassword = '${{ steps.password-gen.outputs.generated-password }}'
`$adUserSsmPassword = '/secure/dbpassword'
`$sqlActivity = 'create-user'
"@

    $finalScript = "$paramBlock`n$scriptContent"

    # Send the command via SSM
    $commandId = aws ssm send-command `
      --document-name "AWS-RunPowerShellScript" `
      --targets "Key=instanceIds,Values=$env:INSTANCE_ID" `
      --parameters commands=@("$finalScript") `
      --comment "Run script via SSM" `
      --region "$env:AWS_REGION" `
      --query "Command.CommandId" `
      --output text

    echo "command-id=$commandId" >> $env:GITHUB_OUTPUT


LY_eM8BXKTXzYHG
