name: Test Generate and Store Password

on:
  pull_request:
    paths:
      - 'paassql-pipelines/generate-password/**'
      - '.github/workflows/test-generate-password.yml'

permissions:
  contents: read

jobs:
  success-test:
    name: Success test (Windows only)
    environment: test
    runs-on: [self-hosted, windows, x64, runners-us-east-1]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run generate-password action (Success)
        id: generate
        uses: ./paassql-pipelines/generate-password
        with:
          sql-password-parameter-store: '/test/password/auto-generated'
          aws-region: 'us-east-1'

      - name: ✅ Verify output values
        shell: pwsh
        run: |
          if (-not "${{ steps.generate.outputs.generated-password }}") {
            Write-Error "❌ Missing generated password output."
            exit 1
          }
          if (-not "${{ steps.generate.outputs.parameter-path }}") {
            Write-Error "❌ Missing parameter path output."
            exit 1
          }
          Write-Host "✅ Password generated and stored at: ${{ steps.generate.outputs.parameter-path }}"

  failure-test:
    name: Failure test with missing inputs
    needs: success-test
    environment: test
    runs-on: [self-hosted, windows, x64, runners-us-east-1]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Run generate-password with missing inputs
        id: run-failure
        uses: ./paassql-pipelines/generate-password
        continue-on-error: true
        with:
          sql-password-parameter-store: ''
          aws-region: ''

      - name: ✅ Verify failure due to missing inputs
        if: ${{ steps.run-failure.conclusion == 'failure' && !cancelled() }}
        shell: pwsh
        run: |
          Write-Host "✅ Action failed as expected due to missing required inputs"
