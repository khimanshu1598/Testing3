name: Test Transfer Script Action

on:
  pull_request:
    paths:
      - 'paassql-pipelines/transfer-script/**'
      - '.github/workflows/test-transfer-script.yaml'

permissions:
  contents: read

env:
  TEST_INSTANCE_ID: "i-1234567890abcdef0"  # Replace with test EC2 instance ID
  TEST_AWS_REGION: "us-east-1"            # Replace with test region

jobs:
  success-test:
    runs-on: [ self-hosted, windows, runners-us-east-1 ]
    environment: test
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Create test script
      shell: powershell
      run: |
        # Create dummy script for testing
        $scriptPath = "${{ github.workspace }}/paassql-pipelines/transfer-script/sql-actions.ps1"
        New-Item -ItemType File -Path $scriptPath -Force | Out-Null
        Add-Content -Path $scriptPath -Value "# Test script content"
        Write-Host "Created test script at $scriptPath"

    - name: Run transfer action
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: '[{"instance":"${{ env.TEST_INSTANCE_ID }}","dbServerName":"test-db","role":"test-role"}]'
      with:
        destination-path: "C:\\temp\\scripts"
        aws-region: ${{ env.TEST_AWS_REGION }}

  input-validation:
    runs-on: [ self-hosted, windows, runners-us-east-1 ]
    strategy:
      matrix:
        missing_input: ['destination-path', 'aws-region']
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Test missing [${{ matrix.missing_input }}]
      id: validation-test
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: '[{"instance":"i-dummy","dbServerName":"test-db","role":"test-role"}]'
      with:
        destination-path: ${{ matrix.missing_input != 'destination-path' && 'C:\\valid' || '' }}
        aws-region: ${{ matrix.missing_input != 'aws-region' && 'us-east-1' || '' }}
      continue-on-error: true

    - name: Verify failure
      if: ${{ !cancelled() }}
      shell: powershell
      run: |
        if (${{ steps.validation-test.outcome }} -ne 'failure') {
          Write-Error "Action should have failed with missing ${{ matrix.missing_input }}"
          exit 1
        }
        Write-Host "✓ Correctly failed with missing ${{ matrix.missing_input }}"

  script-validation:
    runs-on: [ self-hosted, windows, runners-us-east-1 ]
    steps:
    - name: Checkout action
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          paassql-pipelines/transfer-script
          .github

    - name: Delete script file to simulate missing script
      shell: powershell
      run: |
        $scriptPath = "${{ github.workspace }}/paassql-pipelines/transfer-script/sql-actions.ps1"
        if (Test-Path $scriptPath) { Remove-Item $scriptPath }

    - name: Verify script validation fails
      id: script-test
      uses: ./paassql-pipelines/transfer-script
      env:
        MATRIX_INSTANCE_LIST: '[{"instance":"i-dummy","dbServerName":"test-db","role":"test-role"}]'
      with:
        destination-path: "C:\\temp\\scripts"
        aws-region: "us-east-1"
      continue-on-error: true

    - name: Check failure
      if: ${{ !cancelled() }}
      shell: powershell
      run: |
        if (${{ steps.script-test.outcome }} -ne 'failure') {
          Write-Error "Action should have failed with missing script file"
          exit 1
        }
        Write-Host "✓ Correctly failed with missing script file"
