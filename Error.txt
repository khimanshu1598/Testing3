name: 'Generate and Store Password'
description: 'Generates a secure 12-character password (2 of each type) and stores it in AWS SSM'

inputs:
  sql-password-parameter-store:
    description: 'Name of the system manager parameter store which contains password for sql user'
    required: true
  aws-region:
    description: 'AWS region details'
    required: true

outputs:
  parameter-path:
    description: 'Name of the system manager parameter store which contains password for sql user'
    value: ${{ steps.store.outputs.parameter-path }}
  generated-password:
    description: 'The generated password'
    value: ${{ steps.generate-password.outputs.generated-password }}
paassql-pipelines/generate-password/action.yaml: -

runs:
  using: "composite"
  steps:
  - name: Generate password
    id: generate-password
    shell: powershell
    run: |
      # Generate 2 of each character type (total 12 chars)
      $upper = (65..90 | Get-Random -Count 3 | ForEach-Object { [char]$_ })
      $lower = (97..122 | Get-Random -Count 3 | ForEach-Object { [char]$_ })
      $numbers = (48..57 | Get-Random -Count 3 | ForEach-Object { [char]$_ })
      $special = "!#%"

      # Combine and shuffle
      $password = -join ($upper + $lower + $numbers + $special | Sort-Object { Get-Random })

      echo "::add-mask::$password"
      echo "generated-password=$password" >> $env:GITHUB_OUTPUT

      # Store it in a temporary file for next step
      Set-Content -Path "$env:GITHUB_WORKSPACE\generated_password.txt" -Value $password

  - name: Store in Parameter Store
    id: store
    shell: powershell
    run: |
      $parameterName = "${{ inputs.sql-password-parameter-store }}"
      $region = "${{ inputs.aws-region }}"
      $password = Get-Content "$env:GITHUB_WORKSPACE\generated_password.txt"

      aws ssm put-parameter `
        --name "$parameterName" `
        --value "$password" `
        --type "SecureString" `
        --overwrite `
        --region "$region"

      echo "parameter-path=$parameterName" >> $env:GITHUB_OUTPUT
      Remove-Item "$env:GITHUB_WORKSPACE\generated_password.txt" -Force
