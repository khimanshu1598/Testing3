paassql-pipelines/oidc-and-sqlpackage-installation/action.yaml: -

name: 'Download Packages and dependencies'
description: 'Download different utility files and dependencies which are required for the DACPAC deployment.'
inputs:
  oidc-role:
    description: 'OIDC Role to assume'
    required: true
  oidc-target-role:
    description: 'OIDC Target Role to assume (Deployment Role)'
    required: true
  aws-region:
    description: 'AWS region (default: us-east-1)'
    default: 'us-west-2'

runs:
  using: "composite"
  steps:

  - name: Assume OIDC role
    id: assume_oidc_role
    uses: xero-internal/github-actions/aws-assume-oidc@main
    with:
      oidc-role-to-assume: ${{ inputs.oidc-role }}
      target-role-to-assume: ${{ inputs.oidc-target-role }}
      aws-region: ${{ inputs.aws-region }}

  - name: Install jq on Windows
    shell: powershell
    run: |
      Invoke-WebRequest -Uri "https://github.com/stedolan/jq/releases/latest/download/jq-win64.exe" -OutFile "$env:USERPROFILE\jq.exe"
      echo "$env:USERPROFILE" | Out-File -Append -FilePath $env:GITHUB_PATH

  - name: ðŸ“¦ Download and install sqlpackage
    shell: powershell
    run: |
      $zipUrl = "https://aka.ms/sqlpackage-windows"
      $downloadPath = "${{ github.workspace }}\sqlpackage.zip" 
      $extractPath = "${{ github.workspace }}\sqlpackage"
      Write-Host "SQLPackage will be installed in: $extractPath"

      Invoke-WebRequest -Uri $zipUrl -OutFile $downloadPath -UseBasicParsing

      if (Test-Path $extractPath) {
        Remove-Item -Path $extractPath -Recurse -Force
      }
      Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
      Remove-Item $downloadPath

      echo "SQLPACKAGE_PATH=$extractPath" >> $env:GITHUB_ENV
