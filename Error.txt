paassql-pipelines/oidc-and-sqlpackage-installation/action.yaml

name: 'Download Packages and dependencies'
description: 'Download utility files and dependencies (jq, SqlPackage) required for DACPAC deployment using OIDC-authenticated AWS access.'

runs:
  using: "composite"
  steps:
  - name: Download and install SqlPackage
    shell: powershell
    run: |
      $zipUrl = "https://aka.ms/sqlpackage-windows"
      $downloadPath = "${{ github.workspace }}\sqlpackage.zip"
      $extractPath = "${{ github.workspace }}\sqlpackage"

      Write-Host "Installing SqlPackage into: $extractPath"

      # Download SqlPackage ZIP
      Invoke-WebRequest -Uri $zipUrl -OutFile $downloadPath -UseBasicParsing

      # Clean previous install
      if (Test-Path $extractPath) {
        Remove-Item -Path $extractPath -Recurse -Force
      }

      # Extract and cleanup
      Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
      Remove-Item $downloadPath -Force

      # Set path for use in downstream steps
      echo "SQLPACKAGE_PATH=$extractPath" >> $env:GITHUB_ENV
