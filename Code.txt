name: 'Get EC2 Instance ID from Dynamite API'
description: 'Retrieves instance ID based on DB name, role, AWS region and environment'
inputs:
  target-servers:
    description: 'The host to deploy the DACPAC to'
    required: true
  db-name:
    description: 'The database name the DACPAC is being applied against'
    required: true
  role-list:
    description: 'List of roles associated with target servers (JSON array or comma-separated)'
    required: true
  db-server-host:
    description: 'DB server hostname (depending upon the environment)'
    required: false
  is-test-account:
    description: 'Boolean value for impersonating user via Windows Authentication'
    required: true
    default: 'false'
  aws-region:
    description: 'AWS region where the instances are located'
    required: true
  working-directory:
    description: 'Directory where the action will execute'
    required: false
    default: '.'
    
outputs:
  MATRIX_INSTANCE_LIST:
    description: 'JSON matrix containing instance IDs, DB server names, and roles'

runs:
  using: "composite"
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        if [ -z "${{ inputs.target-servers }}" ]; then
          echo "::error::target-servers input is required"
          exit 1
        fi
        if [ -z "${{ inputs.db-name }}" ]; then
          echo "::error::db-name input is required"
          exit 1
        fi
        if [ -z "${{ inputs.role-list }}" ]; then
          echo "::error::role-list input is required"
          exit 1
        fi
        if [ -z "${{ inputs.aws-region }}" ]; then
          echo "::error::aws-region input is required"
          exit 1
        fi
        
    # Rest of your existing steps remain the same...
    # [Previous PowerShell steps here...]


#################

# Get EC2 Instance ID from Dynamite API

Retrieves EC2 instance IDs based on database name, role, AWS region and environment using the Dynamite API.

## Inputs

| Name | Description | Required | Default |
|------|-------------|----------|---------|
| `target-servers` | The host to deploy the DACPAC to | yes | - |
| `db-name` | The database name being applied against | yes | - |
| `role-list` | List of roles (JSON array or comma-separated) | yes | - |
| `db-server-host` | DB server hostname | no | - |
| `is-test-account` | Use Windows Authentication impersonation | yes | `false` |
| `aws-region` | AWS region where instances are located | yes | - |
| `working-directory` | Directory where action executes | no | `.` |

## Outputs

- `MATRIX_INSTANCE_LIST`: JSON matrix containing instance IDs, DB server names, and roles

## Example Usage

```yaml
- uses: paassql-pipelines/get-ec2instance-id@v1
  with:
    target-servers: 'my-db-server'
    db-name: 'production-db'
    role-list: '["primary", "secondary"]'
    aws-region: 'us-east-1'
    is-test-account: false
```

## Supported Runners

- Windows
- Linux (requires PowerShell Core)

## Required Permissions

- AWS EC2 read permissions (when `is-test-account: true`)
- Network access to Dynamite API (when `is-test-account: false`)
