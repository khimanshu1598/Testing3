# Script Transfer Action

Transfers PowerShell scripts to target EC2 instances using AWS Systems Manager (SSM).

## Inputs

| Name | Description | Required | Validation |
|------|-------------|----------|------------|
| `destination-path` | Target directory path on remote server | Yes | Valid Windows path |
| `aws-region` | AWS region of target instances | Yes | Valid AWS region name |

## Prerequisites

1. **AWS Permissions**:
   - `ssm:SendCommand`
   - `ssm:ListCommandInvocations`
2. **Target EC2**:
   - SSM Agent installed and running
   - Network connectivity from GitHub Actions runner
   - PowerShell available on target
3. **Environment Variable**:
   - `MATRIX_INSTANCE_LIST` must contain valid instance information

## Example Usage

```yaml
- uses: paassql-pipelines/transfer-script@v1
  with:
    destination-path: 'C:\scripts\sql'
    aws-region: 'us-east-1'
  env:
    MATRIX_INSTANCE_LIST: ${{ steps.previous-step.outputs.MATRIX_INSTANCE_LIST }}
```

## Behavior

1. Encodes `sql-actions.ps1` as base64
2. Creates target directory if needed
3. Transfers script to all instances in `MATRIX_INSTANCE_LIST`
4. Waits for successful transfer with 5-minute timeout
5. Fails if any instance transfer fails

## Supported Runners

- **Linux**: Requires AWS CLI and `jq`
- **Windows**: Native PowerShell support

## Error Handling

Fails if:
- Required inputs are missing
- AWS permissions insufficient
- Target directory cannot be created
- Script transfer times out
- Any instance in matrix fails


##################

runs:
  using: composite
  steps:
    - name: Validate inputs
      shell: bash
      run: |
        # Validate required inputs
        if [ -z "${{ inputs.destination-path }}" ]; then
          echo "::error::destination-path is required"
          exit 1
        fi
        
        if [ -z "${{ inputs.aws-region }}" ]; then
          echo "::error::aws-region is required"
          exit 1
        fi
        
        # Validate AWS region format (basic check)
        if [[ ! "${{ inputs.aws-region }}" =~ ^[a-z]{2}-[a-z]+-[0-9]$ ]]; then
          echo "::error::Invalid AWS region format"
          exit 1
        fi
        
        # Validate MATRIX_INSTANCE_LIST exists
        if [ -z "$MATRIX_INSTANCE_LIST" ]; then
          echo "::error::MATRIX_INSTANCE_LIST environment variable is required"
          exit 1
        fi
        
        # Validate script exists
        if [ ! -f "${{ github.action_path }}/sql-actions.ps1" ]; then
          echo "::error::sql-actions.ps1 not found in action directory"
          exit 1
        fi
