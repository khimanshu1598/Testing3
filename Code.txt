name: 'Download Packages and dependencies'
description: 'Download utility files and dependencies (jq, SqlPackage) required for DACPAC deployment using OIDC-authenticated AWS access.'

inputs:
  oidc-role:
    description: 'OIDC role to assume'
    required: true

  oidc-target-role:
    description: 'OIDC target (deployment) role to assume'
    required: true

  aws-region:
    description: 'AWS region (default: us-west-2)'
    required: false
    default: 'us-west-2'

runs:
  using: "composite"
  steps:
    - name: üîç Validate inputs
      shell: powershell
      run: |
        if (-not "${{ inputs.oidc-role }}") {
          Write-Error "‚ùå Input 'oidc-role' is required but not provided."
          exit 1
        }
        if (-not "${{ inputs.oidc-target-role }}") {
          Write-Error "‚ùå Input 'oidc-target-role' is required but not provided."
          exit 1
        }

    - name: üîê Assume OIDC role
      id: assume_oidc_role
      uses: xero-internal/github-actions/aws-assume-oidc@main
      with:
        oidc-role-to-assume: ${{ inputs.oidc-role }}
        target-role-to-assume: ${{ inputs.oidc-target-role }}
        aws-region: ${{ inputs.aws-region }}

    - name: üß∞ Install jq on Windows
      shell: powershell
      run: |
        $jqPath = "$env:USERPROFILE\jq.exe"
        Invoke-WebRequest -Uri "https://github.com/stedolan/jq/releases/latest/download/jq-win64.exe" -OutFile $jqPath
        echo "$env:USERPROFILE" | Out-File -Append -FilePath $env:GITHUB_PATH

    - name: üì¶ Download and install SqlPackage
      shell: powershell
      run: |
        $zipUrl = "https://aka.ms/sqlpackage-windows"
        $downloadPath = "${{ github.workspace }}\sqlpackage.zip"
        $extractPath = "${{ github.workspace }}\sqlpackage"

        Write-Host "üìÇ Installing SqlPackage into: $extractPath"

        # Download SqlPackage ZIP
        Invoke-WebRequest -Uri $zipUrl -OutFile $downloadPath -UseBasicParsing

        # Clean previous install
        if (Test-Path $extractPath) {
          Remove-Item -Path $extractPath -Recurse -Force
        }

        # Extract and cleanup
        Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
        Remove-Item $downloadPath -Force

        # Set path for use in downstream steps
        echo "SQLPACKAGE_PATH=$extractPath" >> $env:GITHUB_ENV



# üì¶ OIDC and SqlPackage Installer

This GitHub Action assumes an OIDC role for AWS access and downloads utility dependencies like `jq` and `SqlPackage` required for DACPAC deployments on Windows runners.

---

## üì• Inputs

| Name               | Description                                                               | Required | Default     |
|--------------------|---------------------------------------------------------------------------|----------|-------------|
| `oidc-role`        | The OIDC role to assume                                                    | Yes      | ‚Äì           |
| `oidc-target-role` | The OIDC target (deployment) role to assume                               | Yes      | ‚Äì           |
| `aws-region`       | AWS region in which the roles exist                                       | No       | us-west-2   |

---

## üñ•Ô∏è Supported Runners

- `windows-latest`

> This action is compatible only with **Windows** runners as it installs `sqlpackage.exe` and `jq.exe` using PowerShell.

---

## üîê Required Permissions

To successfully run this action, the GitHub Actions environment must:

- Be configured to use GitHub OIDC authentication
- Have permission to assume the roles passed via `oidc-role` and `oidc-target-role`

---

## ‚ñ∂Ô∏è Example Usage

```yaml
- name: Install SqlPackage and dependencies
  uses: ./paassql-pipelines/oidc-and-sqlpackage-installation
  with:
    oidc-role: arn:aws:iam::123456789012:role/github-oidc-base-role
    oidc-target-role: arn:aws:iam::123456789012:role/github-deployment-role
    aws-region: us-west-2
